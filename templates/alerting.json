{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "webAppName": {
            "type": "String"
        },
        "databaseName": {
            "type": "String"
        },
        "actionGroupName": {
            "type": "string"
        },
        "actionGroupShortName": {
            "type": "string"
        },
        "supportEmailAddresses": {
            "type": "array"
        },
        "thresholdHttpErrors": {
            "type": "string"
        },
        "thresholdResponseTime": {
            "type": "string"
        },
        "thresholdPostgresActiveConnections": {
            "type": "string"
        },
        "thresholdPostgresCPUPercent": {
            "type": "string"
        },
        "thresholdPostgresStoragePercent": {
            "type": "string"
        },
        "activityLogAlertsName": {
            "defaultValue": "ServiceHealthActivityLogAlert",
            "type": "String"
        }
    },
    "variables": {
        "deploymentUrlBase": "https://raw.githubusercontent.com/DFE-Digital/get-help-to-retrain-devops/master/templates/",
        "alertScope":"[concat('/','subscriptions','/',subscription().subscriptionId)]"
    },
    "resources": [
        {
            "apiVersion": "2018-05-01",
            "name": "active-connections-alert",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[concat(variables('deploymentUrlBase'), 'insights-metric-alerts.json')]"
                },
                "parameters": {
                   "alertName": {
                       "value": "Active connections too high"
                   },
                   "alertDescription": {
                       "value": "Active connections too high"
                   },
                   "alertSeverity": {
                       "value":2
                   },
                   "isEnabled": {
                       "value": true
                   },
                   "resourceId": {
                       "value": "[resourceId('Microsoft.DBforPostgreSQL/servers', parameters('databaseName'))]"
                   },
                   "metricName": {
                       "value": "active_connections"
                   },
                   "operator": {
                       "value": "GreaterThan"
                   },
                   "threshold": {
                       "value": "[parameters('thresholdPostgresActiveConnections')]"
                   },
                   "timeAggregation": {
                       "value": "Average"
                   },
                   "actionGroupId": {
                       "value": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]" 
                   }
                }
            }
        },
        {
            "apiVersion": "2018-05-01",
            "name": "cpu-percentage-alert",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[concat(variables('deploymentUrlBase'), 'insights-metric-alerts.json')]"
                },
                "parameters": {
                   "alertName": {
                       "value": "CPU percent too high"
                   },
                   "alertDescription": {
                       "value": "CPU percent too high"
                   },
                   "alertSeverity": {
                       "value":2
                   },
                   "isEnabled": {
                       "value": true
                   },
                   "resourceId": {
                       "value": "[resourceId('Microsoft.DBforPostgreSQL/servers', parameters('databaseName'))]"
                   },
                   "metricName": {
                       "value": "cpu_percent"
                   },
                   "operator": {
                       "value": "GreaterThan"
                   },
                   "threshold": {
                       "value": "[parameters('thresholdPostgresCPUPercent')]"
                   },
                   "timeAggregation": {
                       "value": "Average"
                   },
                   "actionGroupId": {
                       "value": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]" 
                   }
                }
            }
        },
        {
            "apiVersion": "2018-05-01",
            "name": "storage-percent-alert",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[concat(variables('deploymentUrlBase'), 'insights-metric-alerts.json')]"
                },
                "parameters": {
                   "alertName": {
                       "value": "Storage percent too high"
                   },
                   "alertDescription": {
                       "value": "Storage percent too high"
                   },
                   "alertSeverity": {
                       "value":2
                   },
                   "isEnabled": {
                       "value": true
                   },
                   "resourceId": {
                       "value": "[resourceId('Microsoft.DBforPostgreSQL/servers', parameters('databaseName'))]"
                   },
                   "metricName": {     
                       "value": "storage_percent"
                   },
                   "operator": {
                       "value": "GreaterThan"
                   },
                   "threshold": {
                       "value": "[parameters('thresholdPostgresStoragePercent')]"
                   },
                   "timeAggregation": {
                       "value": "Average"
                   },
                   "actionGroupId": {
                       "value": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]"
                   }
                }
            }
        },
        {
            "apiVersion": "2018-05-01",
            "name": "average-response-alert",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[concat(variables('deploymentUrlBase'), 'insights-metric-alerts.json')]"
                }, 
                "parameters": {
                   "alertName": {
                       "value": "Average Response Time too high"
                   },
                   "alertDescription": {
                       "value": "Average Response Time too high"
                   },
                   "alertSeverity": {
                       "value":2
                   },
                   "isEnabled": {
                       "value": true
                   },
                   "resourceId": {
                       "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
                   },
                   "metricName": {     
                       "value": "AverageResponseTime"
                   },
                   "operator": {
                       "value": "GreaterThan"
                   },
                   "threshold": {
                       "value": "[parameters('thresholdResponseTime')]"
                   },
                   "timeAggregation": {
                       "value": "Average"
                   },
                   "actionGroupId": {
                       "value": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]"
                   }
                }
            }
        },
        {
            "apiVersion": "2018-05-01",
            "name": "http-server-errors-alert",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "contentVersion": "1.0.0.0",
                    "uri": "[concat(variables('deploymentUrlBase'), 'insights-metric-alerts.json')]"
                },
                "parameters": {
                   "alertName": {
                       "value": "Http Server Errors too high"
                   },
                   "alertDescription": {
                       "value": "Http Server Errors too high"
                   },
                   "alertSeverity": {
                       "value":2
                   },
                   "isEnabled": {
                       "value": true
                   },
                   "resourceId": {
                       "value": "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
                   },
                   "metricName": {
                       "value": "Http5xx"
                   },
                   "operator": {
                       "value": "GreaterThan"
                   },
                   "threshold": {
                       "value": "[parameters('thresholdHttpErrors')]"
                   },
                   "timeAggregation": {
                       "value": "Total"
                   },
                   "actionGroupId": {
                       "value": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]"
                   }
                }
            }
        },
        {
            "type": "microsoft.insights/actionGroups",
            "apiVersion": "2018-03-01",
            "name": "[parameters('actionGroupName')]",
            "location": "Global",
            "properties": {
                "groupShortName": "[parameters('actionGroupShortName')]",
                "enabled": true,
                "copy": [{
                    "name": "emailReceivers",
                    "count": "[length(parameters('supportEmailAddresses'))]",
                    "input": {
                         "name": "[concat('email ',parameters('supportEmailAddresses')[copyIndex('emailReceivers')].name, '_-EmailAction-')]",
                         "emailAddress": "[parameters('supportEmailAddresses')[copyIndex('emailReceivers')].email]"
                    }
                 }],
                "smsReceivers": [],
                "webhookReceivers": [],
                "itsmReceivers": [],
                "azureAppPushReceivers": [],
                "automationRunbookReceivers": [],
                "voiceReceivers": [],
                "logicAppReceivers": [],
                "azureFunctionReceivers": []
            }
        },
        {
            "comments": "Service Health Activity Log Alert",
            "type": "microsoft.insights/activityLogAlerts",
            "name": "[parameters('activityLogAlertsName')]",
            "apiVersion": "2017-04-01",
            "location": "Global",
            "tags": {},
            "scale": null,
            "properties": {
                "scopes": [
                    "[variables('alertScope')]"
                ],
                "condition": {
                    "allOf": [
                        {
                            "field": "category",
                            "equals": "ServiceHealth"
                        },
                        {
                            "field": "properties.impactedServices[*].ServiceName",
                            "containsAny": [
                                "Azure Database for PostgreSQL",
                                "Redis Cache",
                                "App Service \\ Web Apps",
                                "App Service (Linux) \\ Web App for Containers",
                                "App Service (Linux) \\ Web Apps",
                                "Alerts",
                                "Alerts & Metrics",
                                "App Service",
                                "App Service (Linux)",
                                "Application Insights",
                                "Azure Monitor",
                                "Key Vault",
                                "Log Analytics",
                                "Storage"
                            ]
                        },
                        {
                            "field": "properties.impactedServices[*].ImpactedRegions[*].RegionName",
                            "containsAny": [
                                "UK South",
                                "Global"
                            ]
                        }
                    ]
                },
                "actions": {
                    "actionGroups": [
                        {
                            "actionGroupId": "[resourceId('Microsoft.Insights/actionGroups', parameters('actionGroupName'))]",
                            "webhookProperties": {}
                        }
                    ]
                },
                "enabled": true,
                "description": ""
            }
        }
    ]
}
